<!DOCTYPE html>
<html>
<head>
    <!-- Pyodide and CodeMirror -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/pastel-on-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="192x192" href="../assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../assets/android-chrome-512x512.png">
    
    <!-- Core Stylesheets -->
    <link rel="stylesheet" href=../assets/colours.css>
    <link rel="stylesheet" href="../assets/shared-styles.css">
    <link rel="stylesheet" href="../assets/nav-bar.css">
    <link rel="stylesheet" href="../assets/module_card.css">
    <link rel="stylesheet" href="../assets/learning_outcomes.css">
    <link rel="stylesheet" href="../assets/learning_lists.css">
    <link rel="stylesheet" href="../assets/box_styles.css">
    <link rel="stylesheet" href="../assets/code_styles.css">

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2D - PF0 - Course setup</title>
    
    <!-- File URLs for this lesson -->
    <script>window.LESSON_FILES = []; window.LESSON_PACKAGES = [];</script>
        
</head>
<body>
    
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <a href="../homepage.html" style="text-decoration: none; display: inline-block;">
                <img src="../assets/scryptIQ_logo_dark.png" alt="scryptIQ Logo" class="sidebar-logo">
            </a>
        </div>

        <h3>Content</h3>
        <ul>
            <li><a href="./introduction.html" class="">Introduction</a></li><li><a href="./about-python.html">About Python</a></li><li><a href="./installing-python.html">Installing Python</a></li><li><a href="./essential-tools.html">Essential Tools</a></li><li><a href="./basic-git.html">Basic Git</a></li>
            <li>
                <div class="nav-toggle active" data-target="expandable-section-5">
                    Course setup
                    <span class="toggle-icon">▼</span>
                </div>
                <ul class="nested-nav expanded" id="expandable-section-5"><li><a href="#introduction">Introduction</a></li><li><a href="#github---codespaces">GitHub & Codespaces</a></li><li><a href="#visual-studio-code--vs-code">Visual Studio Code (VS Code)</a></li><li><a href="#git---github--version-control-and-collaboration">Git & GitHub: version control and collaboration</a></li><li><a href="#connecting-your-computer-to-github">Connecting your computer to GitHub</a></li>
                </ul>
            </li><li><a href="./feedback.html">Feedback</a></li>
        </ul>

        <h3 class="collapsible-header collapsed">
            Resources
            <span class="collapse-icon">►</span>
        </h3>
        <div class="collapsible-content collapsed">
            <ul>
                <li><a href="./glossary.html">Glossary</a></li><li><a href="./downloads.html">Downloads</a></li><li><a href="../HB/introduction.html">Handbook</a></li>
            </ul>
        </div>

        <h3>
            <li><a href="./report-issue.html">Report an Issue</a></li>
        </h3>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="sidebar-toggle">❮</button>
    
    <!-- Main Content Area -->
    <div id="main-content" class="main-content">
        <!-- Top Navigation Bar -->
        <div class="top-navbar">
            <h1 class="page-title">Python Orientation</h1>
            <div class="nav-actions">
                <a href="../homepage.html" class="text-button" title="Materials homepage">
                    Homepage
                </a>
                <a href="https://learntodiscover.ai/my-cohorts/" class="text-button" title="Find out more about us">
                    Learn to Discover
                </a>
            </div>
        </div>

        
            <div class="module-card" id="introduction">
                <div class="module-header">
                    Course setup <span class="module-tag">PF0</span>
                </div>
                <div class="module-body">
                    <h3>Learning Objectives</h3>
                    <div class="learning-outcomes">
                        <div class="outcome-item">
                    <span class="outcome-number">1</span>
                    <span class="outcome-text">What are GitHub Codespaces</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">2</span>
                    <span class="outcome-text">Common errors and how to fix them</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">3</span>
                    <span class="outcome-text">How to work locally</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">4</span>
                    <span class="outcome-text">How to connect to GitHub using Git</span>
                </div>
                    </div>
                    <h3>Introduction</h3>
                    <p>Before we begin coding, we&#x27;ll get you set up with the right tools to ensure a smooth and productive workflow. Throughout this course, we make use of modern <strong>development environments</strong> that are widely used in both academic and industry settings, across biological and medical sciences.<br><br>While you don&#x27;t need to install anything on your machine to get started, there are options to do so, depending on how you want to work. Understanding how the setup works will help you become a more confident and independent coder as the course progresses.</p>
                </div>
            </div>
            
            <div class="module-card" id="github---codespaces">
                <div class="module-body">
                    <div class="module-section">
                        <h3>GitHub & Codespaces</h3>
                        <p>All your learning materials, assignments and notebooks are hosted on <strong>GitHub</strong>: the world&#x27;s leading platform for sharing and versioning code. You&#x27;ll receive an individual GitHub repository for each lesson via a GitHub Classroom invitation, sent through our Lesson Portal. These repositories are like digital folders in the cloud that store your assignments, data, and lecture materials.<br><br>To complete your assignments, you&#x27;ll launch a GitHub <strong>Codespace</strong> -- a full coding environment that runs in your browser. Codespaces use <strong>Microsoft Visual Studio Code</strong> behind the scenes and come pre-installed with everything you need: <strong>Python</strong>, <strong>Jupyter</strong> support, required libraries, and version control via Git. This eliminates the need to install anything locally and ensures that all students are working in an identical, error-free environment.<br><br>Codespaces also help us ensure fairness and consistency in grading. Once your work is complete, you&#x27;ll submit it directly through Git&#x27;s version control system - all from inside the Codespace interface. Please refer to the <a href="../HB/assignment-submission.html"><strong>Student Handbook</strong></a>, for a step-by-step guide on how to use Codespaces during the course, or watch the tutorial video below.</p>
        <div class="video-container">
            <iframe 
                src="https://www.youtube.com/embed/dh5RxxdyOCo"
                width="560"
                height="315"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
            </iframe>
        </div>
        <h4>Troubleshooting GitHub Codespaces</h4><p>Sometimes (hopefully not often) Codespaces will generate an error when you try to <em>push</em> back your assignment. This occurs when the main repository is different to the <strong>Codespace</strong> repository, a merge conflict that we discussed earlier.<br><br>To fix this error you can use this workflow:<br><ol class="nested-list"><li>Open the terminal pane in your Codespace (usually cmd + J on a Mac, or ctrl + J on a Windows machine). This should toggle the Terminal pane at the bottom of the window.</li><br><li>Type in the following two commands:</li></ol><pre class="markdown-code-block"><code>git pull origin main</code></pre><br><br>Note: If this doesn&#x27;t work, try: <code>git pull origin master</code><br><br><pre class="markdown-code-block"><code>git config pull.rebase false</code></pre><br><br>You should then be able to submit the assignment, as usual.<br><br>This information is to be used in tandem with &#x27;how to submit&#x27; in the student handbook.<br></p>
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="visual-studio-code--vs-code">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Visual Studio Code (VS Code)</h3>
                        <p>If you prefer to work locally, you can download and install VSCode on your machine, see <a href="./essential-tools.html"><strong>Essential tools</strong></a> for more information about the it and a guide to downloading. Often this route may be a requirement, if you are using an institutional computer that has certain access privileges on it.<br><br>Whether working online through Codespaces or offline in VSCode, you&#x27;ll be using the same files, notebooks and Git workflows.</p>
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="git---github--version-control-and-collaboration">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Git & GitHub: version control and collaboration</h3>
                        <p>You&#x27;ll use Git to track and save changes to your code, and GitHub to store and share those changes online. We employ these mechanisms in assignment submission, so that you leave the course fully fluent in a professional, industry-standard way of working.<br><br>When you finish an assignment, you&#x27;ll commit your changes and sync them to your repository using Git -- all of which you&#x27;ll do through VSCode. Your feedback and marks will be returned through GitHub Pull Requests, and you&#x27;ll learn how to revise and resubmit work by branching, committing and pushing your code.<br><br>All of this may feel unfamiliar at first, but you&#x27;ll be walked through the process carefully and repeatedly during the course.</p>
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="connecting-your-computer-to-github">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Connecting your computer to GitHub</h3>
                        <p>When you want to clone a repository from GitHub it will give you two options, <strong>HTTPS</strong> and <strong>SSH</strong>. Clicking either will give you a link that you copy and paste into your terminal after <code>git clone</code>.<br><br>Each method needs a different route to authentication to allow the connection to take place. There are differing benefits to each, however this is normally only relevant for developers. Use which ever one looks easiest to you to setup.<br><br>Here is the official guide to setting up Git from <a href="https://docs.github.com/en/get-started/git-basics/set-up-git">GitHub themselves</a>. This should be your primary source for setting up. Although, we will run through it quickly here too.</p>
        <div class="info-box warning-box">
            <div class="box-title">
                <span class="box-icon"></span>
                WARNING
            </div>
            <div class="box-content">
                <p>Before starting on either of these setups, please make sure you have set your username and email address in Git, as set out in <a href="./basic-git.html"><strong>Basic Git</strong></a>.</p>
            </div>
        </div>
        <h4>Via HTTPS</h4><p>If cloning a repository using HTTPS, it is recommended to use <strong>GitHub CLI</strong>, which is GitHUb on the command line (terminal).<br><br>GitHub CLI will automatically store you Git credentials for you, so that every time you call <code>git clone</code> or <code>git pull</code> this information is passed to GitHub, allowing you access.</p><p>To setup:<ul class="nested-list"><li><a href="https://github.com/cli/cli#installation">Install</a> GitHub CLI on your computer</li><br><li>In the command line, enter <code>gh auth login</code> and follow the prompts:</li><ul class="nested-list"><li>When prompted remember to select <code>HTTPS</code> as your preferred protocol</li><br><li>Enter <code>Y</code> (yes) when asked if you want to authenticate</li></ul></li><br><li>This should take you through to a web portal, where you are asked to login</li></ul></p><p>Once set up, you should no longer need to enter credential every time you make a request.This means any changes you make locally can be saved, tracked and pushed to GitHub with a single command. You can also pull down updates made to your repo from another machine or location. This workflow mirrors ways of working commonly used in research, software development and collaborative coding environments.<br><br>If you run into any issues, head to GitHubs official guides and attempt alternative methods.</p><h4>Via SSH</h4><p>An alternative to <strong>HTTPS</strong> is <strong>SSH</strong> (Secure Shell Protocol), which is a typical method in computing for having two computers securely connect.<br><br>SSH works by creating a <strong>pair of cryptographic keys</strong>:<br><ul class="nested-list"><li>A <strong>private</strong> key, which stays safely <em>stored on your computer</em>.</li><br><li>A <strong>public</strong> key, which you <em>upload to your GitHub account</em>.</li></ul></p><p>Once your SSH key is configured and linked to your GitHub account, it provides a secure <strong>bridge</strong> between:<br><ul class="nested-list"><li>Your <strong>local IDE</strong> (Visual Studio Code), where you write and edit code</li><br><li>Your <strong>GitHub repository</strong>, where your files are stored and versioned online</li></ul></p><p>To setup:<ul class="nested-list"><li><strong>Generate a new SSH key</strong> and add it to your <strong>SSH agent</strong> (your system&#x27;s secure key manager): <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">Click here for GitHubs guide</a></li><br><li><strong>Add the SSH key to your GitHub account</strong> to authorise your device: <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">Click here for GitHubs guide</a></li></ul></p><p>Once this is set up, your Git commands in VS Code (including pull, commit, push) will automatically use SSH in the background to verify your identity, allowing for secure and seamless integration between your desktop code editor and GitHub.</p>
                    </div>
                </div>
            </div>
            
        
        <div class="page-navigation">
            <a href="./basic-git.html" class="nav-button prev">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                Previous
            </a></div>
        
        <!-- Footer -->
        <div class="footer">
            <div>© All materials are copyright scryptIQ 2025</div>
            <div>Powered by Pyodide</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/main.js"></script>
    
    <!-- Pyodide Initialisation Script -->
    <script>

// Generalisable Pyodide Initialisation Script
// Variables and state build up naturally as code blocks execute in order

async function main() {
    // Show loading message for all output elements
    document.querySelectorAll(".output").forEach(el => {
        el.textContent = "Loading Pyodide...";
        el.classList.add("loading-message");
    });
    
    try {
        // Load Pyodide
        console.log("Loading Pyodide...");
        const pyodideStartTime = performance.now();
        let pyodide = await loadPyodide();
        const pyodideLoadTime = performance.now() - pyodideStartTime;
        console.log(`Pyodide loaded in ${pyodideLoadTime.toFixed(2)}ms`);
        
        // Load required packages only if specified
        const lessonPackages = window.LESSON_PACKAGES || [];
        
        if (lessonPackages.length > 0) {
            console.log("Loading required Python packages...");
            const packagesStartTime = performance.now();
            
            // Separate built-in packages from PyPI packages
            const builtInPackages = lessonPackages.filter(pkg => 
                ['numpy', 'scipy', 'matplotlib', 'pandas', 'scikit-learn', 'pillow', 'regex'].includes(pkg)
            );
            
            const micropipPackages = lessonPackages.filter(pkg => !builtInPackages.includes(pkg));
            
            // Load built-in packages (fast)
            if (builtInPackages.length > 0) {
                await pyodide.loadPackage(builtInPackages);
                console.log(`Loaded built-in packages: ${builtInPackages.join(', ')}`);
            }
            
            // Install PyPI packages (slower)
            if (micropipPackages.length > 0) {
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport('micropip');
                await micropip.install(micropipPackages);
                console.log(`Installed PyPI packages: ${micropipPackages.join(', ')}`);
            }
            
            const packagesLoadTime = performance.now() - packagesStartTime;
            console.log(`Packages loaded in ${packagesLoadTime.toFixed(2)}ms`);
            console.log(`Total initialisation time: ${(pyodideLoadTime + packagesLoadTime).toFixed(2)}ms`);
        } else {
            console.log("No packages to load for this lesson");
            console.log(`Total initialisation time: ${pyodideLoadTime.toFixed(2)}ms`);
        }

        // Only set up basic Python environment - no pre-loaded variables
        await pyodide.runPythonAsync(`
            import sys
            from io import StringIO
        `);

        // Only set up matplotlib if it's in the loaded packages
        if (lessonPackages.includes('matplotlib')) {
            await pyodide.runPythonAsync(`
                # Set up matplotlib for web rendering
                import matplotlib
                matplotlib.use('AGG')
                import matplotlib.pyplot as plt
                import io
                import base64
                
                def capture_matplotlib():
                    """Capture current matplotlib figure as HTML img tag"""
                    buf = io.BytesIO()
                    plt.savefig(buf, format='png', bbox_inches='tight', dpi=100)
                    buf.seek(0)
                    img_base64 = base64.b64encode(buf.read()).decode('utf-8')
                    plt.close()
                    return f'<img src="data:image/png;base64,{img_base64}" style="max-width: 100%; height: auto;" />'
            `);
            console.log('Matplotlib capture function set up');
        }
        
        console.log("Pyodide loaded successfully");
        
        // Load remote files if URLs are specified
        const lessonFiles = window.LESSON_FILES || [];
        
        if (lessonFiles.length > 0) {
            try {
                console.log(`Checking for ${lessonFiles.length} remote file(s) to load...`);
                
                // Build Python code to load all files dynamically
                let pythonCode = `
from pyodide.http import pyfetch
import os

# Create data directory if it doesn't exist
os.makedirs('./data', exist_ok=True)
`;
                
                // Add loading code for each file
                for (const file of lessonFiles) {
                    pythonCode += `
# Load ${file.filename}
try:
    response = await pyfetch("${file.url}")
    content = await response.string()
    with open('./data/${file.filename}', 'w') as f:
        f.write(content)
    print("Loaded: ${file.filename}")
except Exception as e:
    print(f"Could not load ${file.filename}: {e}")
`;
                }
                
                await pyodide.runPythonAsync(pythonCode);
                console.log("Remote files loaded successfully");
            } catch (error) {
                console.warn("Error loading remote files (continuing anyway):", error);
            }
        } else {
            console.log("No remote files to load for this lesson");
        }
        
        // Function to execute Python code and capture output
        async function executePythonCode(code) {
            try {
                // Redirect Python stdout to capture print statements
                await pyodide.runPythonAsync(`
                    old_stdout = sys.stdout
                    sys.stdout = mystdout = StringIO()
                `);
                
                // Run the user code
                const result = await pyodide.runPythonAsync(code);
                
                // Get the captured stdout
                let stdout = await pyodide.runPythonAsync(`
                    sys.stdout = old_stdout
                    mystdout.getvalue()
                `);
                
                // Check for matplotlib figures only if matplotlib was loaded
                const lessonPackages = window.LESSON_PACKAGES || [];
                if (lessonPackages.includes('matplotlib')) {
                    const hasFigures = await pyodide.runPythonAsync(`
                        import matplotlib.pyplot as plt
                        len(plt.get_fignums()) > 0
                    `);
                    
                    if (hasFigures) {
                        const figureHtml = await pyodide.runPythonAsync(`capture_matplotlib()`);
                        if (stdout) stdout += "\n";
                        stdout += figureHtml;
                    }
                }
                
                // Combine stdout and result
                let output = stdout;
                if (result !== undefined && result !== null && String(result).trim() !== '') {
                    if (output) output += "\n";
                    output += String(result);
                }
                
                return { success: true, output: output || "Code executed successfully (no output)" };
                
            } catch (error) {
                return { success: false, output: "Error: " + error.message };
            }
        }
        
        // Execute all hidden code blocks first (for setup code like imports)
        const hiddenCodeBlocks = Array.from(document.querySelectorAll('.hidden-code textarea'));
        console.log(`Found ${hiddenCodeBlocks.length} hidden code blocks`);

        for (const textarea of hiddenCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            console.log(`Executing hidden code block: ${textarea.id}`);
            const result = await executePythonCode(code);
            
            if (!result.success) {
                console.error(`Error in hidden code block ${textarea.id}:`, result.output);
            } else {
                console.log(`Hidden code block ${textarea.id} executed successfully`);
            }
        }

        console.log("All hidden code blocks executed");
        
        // Get all fixed code blocks in document order
        const fixedCodeBlocks = Array.from(document.querySelectorAll('.code-fixed textarea'));
        
        // Setup and execute fixed code blocks sequentially
        for (const textarea of fixedCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            // Set up CodeMirror editor (read-only)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                readOnly: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding output element
            const outputId = textarea.id + '-output';
            const outputElement = document.getElementById(outputId);
            
            if (outputElement) {
                outputElement.textContent = "Running code...";
                outputElement.classList.add("loading-message");
                
                // Execute the code (this maintains state for subsequent blocks)
                const result = await executePythonCode(code);
                
                // Display the output - check if it's HTML
                const trimmedOutput = result.output.trim();
                console.log('Output length:', trimmedOutput.length);
                console.log('Output starts with:', trimmedOutput.substring(0, 100));
                
                if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                    // It's Plotly HTML output - extract just the body content
                    console.log('Rendering as Plotly HTML');
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.output, 'text/html');
                    // Clear the output element and append the body content
                    outputElement.innerHTML = '';
                    
                    // Find and load external scripts first (like Plotly CDN)
                    const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                    const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                    
                    // Append non-script content first
                    Array.from(doc.body.children).forEach(child => {
                        if (child.tagName !== 'SCRIPT') {
                            outputElement.appendChild(child.cloneNode(true));
                        }
                    });
                    
                    // Load external scripts sequentially
                    const loadScript = (src) => {
                        return new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = src;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    };
                    
                    // Load all external scripts first
                    Promise.all(externalScripts.map(s => loadScript(s.src)))
                        .then(() => {
                            console.log('External scripts loaded, executing inline scripts');
                            // Now execute inline scripts
                            inlineScripts.forEach(oldScript => {
                                const newScript = document.createElement('script');
                                newScript.textContent = oldScript.textContent;
                                outputElement.appendChild(newScript);
                            });
                            console.log('Output element after processing:', outputElement.children.length, 'children');
                        })
                        .catch(err => {
                            console.error('Failed to load external scripts:', err);
                            outputElement.textContent = 'Error loading Plotly: ' + err.message;
                        });
                } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                           trimmedOutput.startsWith('<html') ||
                            trimmedOutput.startsWith('<div') ||
                            trimmedOutput.startsWith('<img')) {
                    console.log('Rendering as generic HTML');
                    outputElement.innerHTML = result.output;
                    console.log('Output element after innerHTML:', outputElement.children.length, 'children');
                } else {
                    console.log('Rendering as plain text');
                    outputElement.textContent = result.output;
                }
                outputElement.classList.remove("loading-message");
                if (result.success) {
                    outputElement.classList.add("success-message");
                    outputElement.classList.remove("error-message");
                } else {
                    outputElement.classList.add("error-message");
                    outputElement.classList.remove("success-message");
                }
            }
            
            // Small delay to show progression
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Setup all editable code blocks (but don't execute them)
        document.querySelectorAll('.code-editor textarea').forEach((textarea) => {
            // Set up CodeMirror editor (editable)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding run button and output element
            const baseId = textarea.id;
            const runButtonId = 'run-' + baseId;
            const outputId = baseId + '-output';
            
            const runButton = document.getElementById(runButtonId);
            const outputElement = document.getElementById(outputId);
            
            if (runButton && outputElement) {
                // Set initial state
                outputElement.textContent = "Ready to run code!";
                outputElement.classList.remove("loading-message");
                
                runButton.addEventListener("click", async () => {
                    const code = editor.getValue().trim();
                    if (!code) {
                        outputElement.textContent = "No code to run";
                        return;
                    }
                    
                    outputElement.textContent = "Running...";
                    outputElement.classList.remove("error-message", "success-message");
                    outputElement.classList.add("loading-message");
                    
                    // Execute the code (this also maintains state for future blocks)
                    const result = await executePythonCode(code);
                    
                    // Display the output - check if it's HTML
                    const trimmedOutput = result.output.trim();
                    console.log('Output length:', trimmedOutput.length);
                    console.log('Output starts with:', trimmedOutput.substring(0, 100));
                    
                    if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                        // It's Plotly HTML output - extract just the body content
                        console.log('Rendering as Plotly HTML');
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(result.output, 'text/html');
                        // Clear the output element and append the body content
                        outputElement.innerHTML = '';
                        
                        // Find and load external scripts first (like Plotly CDN)
                        const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                        const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                        
                        // Append non-script content first
                        Array.from(doc.body.children).forEach(child => {
                            if (child.tagName !== 'SCRIPT') {
                                outputElement.appendChild(child.cloneNode(true));
                            }
                        });
                        
                        // Load external scripts sequentially
                        const loadScript = (src) => {
                            return new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = src;
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        };
                        
                        // Load all external scripts first
                        Promise.all(externalScripts.map(s => loadScript(s.src)))
                            .then(() => {
                                console.log('External scripts loaded, executing inline scripts');
                                // Now execute inline scripts
                                inlineScripts.forEach(oldScript => {
                                    const newScript = document.createElement('script');
                                    newScript.textContent = oldScript.textContent;
                                    outputElement.appendChild(newScript);
                                });
                                console.log('Output element after processing:', outputElement.children.length, 'children');
                            })
                            .catch(err => {
                                console.error('Failed to load external scripts:', err);
                                outputElement.textContent = 'Error loading Plotly: ' + err.message;
                            });
                    } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                               trimmedOutput.startsWith('<html') ||
                               trimmedOutput.startsWith('<div')) {
                        outputElement.innerHTML = result.output;
                    } else {
                        outputElement.textContent = result.output;
                    }
                    outputElement.classList.remove("loading-message");
                    if (result.success) {
                        outputElement.classList.add("success-message");
                        outputElement.classList.remove("error-message");
                    } else {
                        outputElement.classList.add("error-message");
                        outputElement.classList.remove("success-message");
                    }
                });
            }
        });
        
        console.log("All code blocks initialised successfully");

        // Set flag to indicate Pyodide is fully ready
        window.pyodideReady = true;
        console.log("Pyodide fully ready");
        
    } catch (error) {
        console.error("Failed to initialise Pyodide:", error);
        document.querySelectorAll(".output").forEach(el => {
            el.textContent = "Error loading Pyodide: " + error.message;
            el.classList.remove("loading-message");
            el.classList.add("error-message");
        });
    }
}

// Start the application when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
} else {
    main();
}
    </script>
</body>
</html>
    