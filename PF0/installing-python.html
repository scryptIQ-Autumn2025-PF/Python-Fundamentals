<!DOCTYPE html>
<html>
<head>
    <!-- Pyodide and CodeMirror -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/pastel-on-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="192x192" href="../assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../assets/android-chrome-512x512.png">
    
    <!-- Core Stylesheets -->
    <link rel="stylesheet" href="../assets/colours.css">
    <link rel="stylesheet" href="../assets/shared-styles.css">
    <link rel="stylesheet" href="../assets/nav-bar.css">
    <link rel="stylesheet" href="../assets/module_card.css">
    <link rel="stylesheet" href="../assets/learning_outcomes.css">
    <link rel="stylesheet" href="../assets/learning_lists.css">
    <link rel="stylesheet" href="../assets/box_styles.css">
    <link rel="stylesheet" href="../assets/code_styles.css">

    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2D - PF0 - Installing Python</title>
    
    <!-- File URLs for this lesson -->
    <script>window.LESSON_FILES = []; window.LESSON_PACKAGES = [];</script>
        
</head>
<body>
    
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
        </div>
        
        <h3>Content</h3>
        <ul>
            <li><a href="./introduction.html" class="">Introduction</a></li><li><a href="./about-python.html">About Python</a></li>
            <li>
                <div class="nav-toggle active" data-target="expandable-section-2">
                    Installing Python
                    <span class="toggle-icon">▼</span>
                </div>
                <ul class="nested-nav expanded" id="expandable-section-2"><li><a href="#introduction">Introduction</a></li><li><a href="#checking-if-python-is-already-installed">Checking if Python is already installed</a></li><li><a href="#mac">Mac</a></li><li><a href="#windows">Windows</a></li><li><a href="#anaconda">Anaconda</a></li><li><a href="#uv">UV</a></li>
                </ul>
            </li><li><a href="./essential-tools.html">Essential Tools</a></li><li><a href="./basic-git.html">Basic Git</a></li><li><a href="./course-setup.html">Course setup</a></li><li><a href="./feedback.html">Feedback</a></li>
        </ul>

        <h3 class="collapsible-header collapsed">
            Resources
            <span class="collapse-icon">►</span>
        </h3>
        <div class="collapsible-content collapsed">
            <ul>
                <li><a href="./glossary.html">Glossary</a></li><li><a href="./downloads.html">Downloads</a></li><li><a href="../HB/introduction.html">Handbook</a></li>
            </ul>
        </div>

        <h3>
            <li><a href="./report-issue.html">Report an Issue</a></li>
        </h3>
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="sidebar-toggle">❮</button>
    
    <!-- Main Content Area -->
    <div id="main-content" class="main-content">
        <!-- Top Navigation Bar -->
        <div class="top-navbar">
            <h1 class="page-title">Python Orientation</h1>
            <div class="nav-actions">
            </div>
        </div>

        
            <div class="module-card" id="introduction">
                <div class="module-header">
                    Installing Python <span class="module-tag">PF0</span>
                </div>
                <div class="module-body">
                    <h3>Learning Objectives</h3>
                    <div class="learning-outcomes">
                        <div class="outcome-item">
                    <span class="outcome-number">1</span>
                    <span class="outcome-text">How to install Python on Mac and Windows</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">2</span>
                    <span class="outcome-text">About and installing Anaconda</span>
                </div>
<div class="outcome-item">
                    <span class="outcome-number">3</span>
                    <span class="outcome-text">A brief introduction to other Python managers: Anaconda and UV</span>
                </div>
                    </div>
                    <h3>Introduction</h3>
                    <p>One of the most frustrating parts of learning to code can be properly setting up the coding language on your local machine, especially as there can be multiple ways of doing it, including operating system (OS) specific methods.<br><br>Whilst we do offer you the chance to edit, run, and save Python code in a pre-configured computing space with GitHub CodeSpaces (<a href="./course-setup.html">see Course Setup</a>), it is good to learn how to set up Python on your local machine as this is what you&#x27;ll be using for your research.<br><br>This section will run through how to install Python on both Windows and Mac machines (sorry Linux users), both through the Python.org download and through an OS-specific method. Lastly, we&#x27;ll run through Python installation through Anaconda, a research computing software package, and UV, a developer&#x27;s tool for Python.</p><p>As of writing this we recommend Python version <strong>3.13</strong> as a stable but up-to-date release to use. There are continual updates to Python with big changes warranting a change in the first number, i.e. 2 -&gt; 3, and small but still significant changes reflected in the numbers after the <code>.</code>, i.e. 13 -&gt; 14. The latest version are deemed unstable, with potential major bugs that can affect how it runs. You can see the status of each version <a href="https://devguide.python.org/versions/#versions.">here</a></p>
                </div>
            </div>
            
            <div class="module-card" id="checking-if-python-is-already-installed">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Checking if Python is already installed</h3>
                        <p><em>The following section utilises the terminal (Mac &amp; Linux) or command line/PowerShell (Windows). See <a href="./essential-tools.html"><strong>essential tools</strong></a> for an introduction to this topic.</em></p><p>On some systems Python comes pre-installed. You can try running the <code>python</code> command in the terminal (Mac &amp; Linux) or the Command Prompt (Windows) to start the Python interpreter to check and see if it is already installed. On Windows you can also try the <code>py</code> command which is a launcher that is more likely to work. If it is installed you will see a response which will include the version number, see below:<br><br><pre class="markdown-code-block"><code>Python 3.13.2 (main, Feb 12 2025, 14:59:08) [Clang 19.1.6 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</code></pre><br><br>If nothing appears or an error is given then you will need to install Python. Additionally, check the version - the current stable release is <a href="https://www.python.org/downloads/">3.13</a>.<br><br>Your Python version should be at least 3.9 or later.<br><br>You can also just print the version number by adding the version flag like so: <code>python --version</code>.</p>
        <div class="info-box tip-box">
            <div class="box-title">
                <span class="box-icon"></span>
                TIP
            </div>
            <div class="box-content">
                <p><code>python3</code> can be used in place of <code>python</code>. It was added when Python upgraded from Python 2 to Python 3, to distinguish between the two when you had multiple versions on your system. As we don&#x27;t use Python 2 anymore, both should link to the same Python installation. However, sometimes with multiple installations they may call different ones.</p>
            </div>
        </div>
        
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="mac">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Mac</h3>
                        <h4>Via Python.org</h4><p>If you have a macOS between and including 10.9 (Mavericks) and 10.15 (Catalina), the system includes Python 2 already installed. Python 2 is no longer supported and contains outdated Python syntax and should not be used.<br><br>The best way to install Python is through a downloadable installer from <a href="https://www.python.org/downloads/">Python.org</a>. Simply head to the link provided and click the yellow download link to get the latest version.</p><p><img src="./images/python-mac.png" alt="Installing Python for Mac" class="notebook-image"></p><p>The file should be a standard macOS installer package file (.pkg). Double-click on the file to activate the installation process, following the steps it provides. For a more detailed walkthrough head to this <a href="https://docs.python.org/3/using/mac.html">guide</a>.<br><br>After completion there should be a Python 3.X folder in your Applications folder. You should also test it through the methods set out in the <strong>Checking if Python is Already Installed</strong> section.</p><h4>Via Homebrew</h4><p>Some of you may be used to installing software on your Mac using Homebrew, a software package manager. Homebrew-installed Python can be useful if you are already used to it, as it gives you an easy ability to manage your installation. However, there are some drawbacks. Homebrew will update Python automatically as a dependency for other packages, which has the potential to break other projects. Additionally, you will need to add this Python to the system PATH, an extra step compared to the previous method.<br><br>To install, make sure your Homebrew is up-to-date and call the following command in your Mac terminal:<br><br><pre class="markdown-code-block"><code>brew install python</code></pre><br><br>You can install a specific version by using <code>brew search python</code> to find an earlier version, although it only contains a few recent versions. Replace <code>python</code> with your version of choice, i.e., <code>python@3.11</code>. To verify the installation use <code>brew list python</code> to see the installed files. You can prevent automatic upgrades of Python via <code>brew pin python</code> and then call upgrades when wanted with <code>brew upgrade python</code>.<br><br>Once installed, you need to add the Python file to the system Mac PATH. You must complete this next step before it is available for use, otherwise entering the command <code>python</code> will trigger <code>zsh: command not found: python</code>. To add to PATH we will need to edit the <code>.zprofile</code> file, which sets up any new terminal window. To do so we write:<br><br><pre class="markdown-code-block"><code>open -e ~/.zprofile</code></pre><br><br>in the terminal and add:<br><br><pre class="markdown-code-block"><code>export PATH=&quot;$(brew --prefix python)/libexec/bin:$PATH&quot;</code></pre><br><br>to the last line in the file. To have the changes take effect you will need to quit and restart the terminal. Once restarted, verify that Python is installed as instructed previously.</p>
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="windows">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Windows</h3>
                        <h4>Via Python.org</h4><p>As with Mac, the most reliable method to install Python on Windows is through the official installer from <a href="https://www.python.org/downloads/">Python.org</a>. Navigate to the downloads page and click the yellow download button to get the latest version for Windows. See <a href="https://docs.python.org/3/using/windows.html">here</a> for a more detailed walkthrough.<br><br>The downloaded file will be a Windows executable installer (.exe). Before running the installer, there&#x27;s one crucial step that many beginners miss: <strong>make sure to tick the &quot;Add Python to PATH&quot; checkbox</strong> at the bottom of the first installation screen. This is essential for being able to run Python from anywhere in the Command Prompt or PowerShell. Follow the steps in the installer.<br><br>After installation, you should test it using the methods outlined in the <strong>Checking if Python is Already Installed</strong> section. On Windows, you can use either the <code>python</code> command or the <code>py</code> command, with <code>py</code> being the Python launcher that&#x27;s often more reliable on Windows systems.</p><h4>Via Microsoft Store</h4><p>Windows 10 and 11 users have an alternative option through the Microsoft Store. This method can be simpler as it handles PATH configuration automatically and provides automatic updates. However, it may have some limitations for advanced development work.<br><br>To install via Microsoft Store, simply search the store for <code>Python</code> and select the official Python release.</p><p><img src="./images/python-windows.png" alt="Installing Python for Windows" class="notebook-image"></p><p>The Microsoft Store version automatically handles PATH configuration, so you shouldn&#x27;t encounter the common &quot;command not found&quot; issues. However, some advanced Python packages may not work correctly with the Microsoft Store version, particularly those that require compilation or system-level access.<br><br>Verify the installation as shown previously.</p><h4>Common Windows Issues</h4><p><em>&quot;Python is not recognised as an internal or external command&quot;</em><br><br>This usually means Python wasn&#x27;t added to your system PATH. Solutions:<ul class="nested-list"><li>If you used Python.org installer: Re-run the installer, choose &quot;Modify&quot;, and ensure &quot;Add Python to environment variables&quot; is ticked</li><br><li>Try using <code>py</code> instead of <code>python</code></li><br><li>Manually add Python to PATH through System Properties &gt; Environment Variables</li></ul></p>
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="anaconda">
                <div class="module-body">
                    <div class="module-section">
                        <h3>Anaconda</h3>
                        <p>Anaconda is a self contained Python data science distribution that contains:<br><ul class="nested-list"><li>Python (you can select the version)</li><br><li>300 commonly used Python packages (extra, more specific Python code)</li><br><li><strong>conda</strong>: A tool to manage these packages</li><br><li>Anaconda Navigator: A desktop graphical interface to manage your packages and environments</li></ul></p><h4>Why Anaconda and What is an Environment?</h4><p>Anaconda is often recommended to researchers and beginners as it handles a lot for you, all within a graphical interface. This includes handling environments and package dependencies, for more information on these head to <a href="./essential-tools.html"><strong>essential tools</strong></a>. Due to this it is often installed on all university computers and used within teaching sessions for students.</p><h4>Installing Anaconda</h4><p>Head to the <a href="https://www.anaconda.com/docs/getting-started/anaconda/install">Anaconda website</a> for installation guides for each OS. Follow their instructions to install and then how to use Anaconda.</p><h4>Mini-conda</h4><p>The main Anaconda software comes with a lot of bloat, such as the 300 pre-installed packages and graphical interface, that is not needed once you get the hang of things and can eventually be an impediment to projects. If you don&#x27;t want this but like the <code>conda</code> package/environment handler then consider installing <a href="https://www.anaconda.com/docs/getting-started/miniconda/main">miniconda</a> that only includes <code>conda</code>, the package installing manager.</p>
                    </div>
                </div>
            </div>
            
            <div class="module-card" id="uv">
                <div class="module-body">
                    <div class="module-section">
                        <h3>UV</h3>
                        <p>Finally, we would like to briefly mention <a href="https://docs.astral.sh/uv/">UV</a>, a relatively new Python package installer and project management tool that has gained significant traction in the developer community. Written in Rust, UV is exceptionally fast, often 10-100 times quicker than traditional tools, and can manage Python versions, virtual environments, and packages all in one unified tool, similar to Anaconda but with a command-line focus.<br><br>While we won&#x27;t cover UV in detail here, it&#x27;s worth keeping in mind as it&#x27;s rapidly becoming the preferred choice for many Python developers.</p>
                    </div>
                </div>
            </div>
            
        
        <div class="page-navigation">
            <a href="./about-python.html" class="nav-button prev">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                Previous
            </a>
            <a href="./essential-tools.html" class="nav-button next">
                Next
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </a></div>
        
        <!-- Footer -->
        <div class="footer">
            <div>© All materials are copyright scryptIQ 2025</div>
            <div>Powered by Pyodide</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/main.js"></script>
    
    <!-- Pyodide Initialisation Script -->
    <script>

// Generalisable Pyodide Initialisation Script
// Variables and state build up naturally as code blocks execute in order

async function main() {
    // Show loading message for all output elements
    document.querySelectorAll(".output").forEach(el => {
        el.textContent = "Loading Pyodide...";
        el.classList.add("loading-message");
    });
    
    try {
        // Load Pyodide
        console.log("Loading Pyodide...");
        const pyodideStartTime = performance.now();
        let pyodide = await loadPyodide();
        const pyodideLoadTime = performance.now() - pyodideStartTime;
        console.log(`Pyodide loaded in ${pyodideLoadTime.toFixed(2)}ms`);
        
        // Load required packages only if specified
        const lessonPackages = window.LESSON_PACKAGES || [];
        
        if (lessonPackages.length > 0) {
            console.log("Loading required Python packages...");
            const packagesStartTime = performance.now();
            
            // Separate built-in packages from PyPI packages
            const builtInPackages = lessonPackages.filter(pkg => 
                ['numpy', 'scipy', 'matplotlib', 'pandas', 'scikit-learn', 'pillow', 'regex'].includes(pkg)
            );
            
            const micropipPackages = lessonPackages.filter(pkg => !builtInPackages.includes(pkg));
            
            // Load built-in packages (fast)
            if (builtInPackages.length > 0) {
                await pyodide.loadPackage(builtInPackages);
                console.log(`Loaded built-in packages: ${builtInPackages.join(', ')}`);
            }
            
            // Install PyPI packages (slower)
            if (micropipPackages.length > 0) {
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport('micropip');
                await micropip.install(micropipPackages);
                console.log(`Installed PyPI packages: ${micropipPackages.join(', ')}`);
            }
            
            const packagesLoadTime = performance.now() - packagesStartTime;
            console.log(`Packages loaded in ${packagesLoadTime.toFixed(2)}ms`);
            console.log(`Total initialisation time: ${(pyodideLoadTime + packagesLoadTime).toFixed(2)}ms`);
        } else {
            console.log("No packages to load for this lesson");
            console.log(`Total initialisation time: ${pyodideLoadTime.toFixed(2)}ms`);
        }

        // Only set up basic Python environment - no pre-loaded variables
        await pyodide.runPythonAsync(`
            import sys
            from io import StringIO
        `);
        
        console.log("Pyodide loaded successfully");
        
        // Load remote files if URLs are specified
        const lessonFiles = window.LESSON_FILES || [];
        
        if (lessonFiles.length > 0) {
            try {
                console.log(`Checking for ${lessonFiles.length} remote file(s) to load...`);
                
                // Build Python code to load all files dynamically
                let pythonCode = `
from pyodide.http import pyfetch
import os

# Create data directory if it doesn't exist
os.makedirs('./data', exist_ok=True)
`;
                
                // Add loading code for each file
                for (const file of lessonFiles) {
                    pythonCode += `
# Load ${file.filename}
try:
    response = await pyfetch("${file.url}")
    content = await response.string()
    with open('./data/${file.filename}', 'w') as f:
        f.write(content)
    print("Loaded: ${file.filename}")
except Exception as e:
    print(f"Could not load ${file.filename}: {e}")
`;
                }
                
                await pyodide.runPythonAsync(pythonCode);
                console.log("Remote files loaded successfully");
            } catch (error) {
                console.warn("Error loading remote files (continuing anyway):", error);
            }
        } else {
            console.log("No remote files to load for this lesson");
        }
        
        // Function to execute Python code and capture output
        async function executePythonCode(code) {
            try {
                // Redirect Python stdout to capture print statements
                await pyodide.runPythonAsync(`
                    old_stdout = sys.stdout
                    sys.stdout = mystdout = StringIO()
                `);
                
                // Run the user code
                const result = await pyodide.runPythonAsync(code);
                
                // Get the captured stdout
                const stdout = await pyodide.runPythonAsync(`
                    sys.stdout = old_stdout
                    mystdout.getvalue()
                `);
                
                // Combine stdout and result
                let output = stdout;
                if (result !== undefined && result !== null && String(result).trim() !== '') {
                    if (output) output += "\n";
                    output += String(result);
                }
                
                return { success: true, output: output || "Code executed successfully (no output)" };
                
            } catch (error) {
                return { success: false, output: "Error: " + error.message };
            }
        }
        
        // Execute all hidden code blocks first (for setup code like imports)
        const hiddenCodeBlocks = Array.from(document.querySelectorAll('.hidden-code textarea'));
        console.log(`Found ${hiddenCodeBlocks.length} hidden code blocks`);

        for (const textarea of hiddenCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            console.log(`Executing hidden code block: ${textarea.id}`);
            const result = await executePythonCode(code);
            
            if (!result.success) {
                console.error(`Error in hidden code block ${textarea.id}:`, result.output);
            } else {
                console.log(`Hidden code block ${textarea.id} executed successfully`);
            }
        }

        console.log("All hidden code blocks executed");
        
        // Get all fixed code blocks in document order
        const fixedCodeBlocks = Array.from(document.querySelectorAll('.code-fixed textarea'));
        
        // Setup and execute fixed code blocks sequentially
        for (const textarea of fixedCodeBlocks) {
            const code = textarea.value.trim();
            if (!code) continue;
            
            // Set up CodeMirror editor (read-only)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                readOnly: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding output element
            const outputId = textarea.id + '-output';
            const outputElement = document.getElementById(outputId);
            
            if (outputElement) {
                outputElement.textContent = "Running code...";
                outputElement.classList.add("loading-message");
                
                // Execute the code (this maintains state for subsequent blocks)
                const result = await executePythonCode(code);
                
                // Display the output - check if it's HTML
                const trimmedOutput = result.output.trim();
                console.log('Output length:', trimmedOutput.length);
                console.log('Output starts with:', trimmedOutput.substring(0, 100));
                
                if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                    // It's Plotly HTML output - extract just the body content
                    console.log('Rendering as Plotly HTML');
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.output, 'text/html');
                    // Clear the output element and append the body content
                    outputElement.innerHTML = '';
                    
                    // Find and load external scripts first (like Plotly CDN)
                    const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                    const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                    
                    // Append non-script content first
                    Array.from(doc.body.children).forEach(child => {
                        if (child.tagName !== 'SCRIPT') {
                            outputElement.appendChild(child.cloneNode(true));
                        }
                    });
                    
                    // Load external scripts sequentially
                    const loadScript = (src) => {
                        return new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = src;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    };
                    
                    // Load all external scripts first
                    Promise.all(externalScripts.map(s => loadScript(s.src)))
                        .then(() => {
                            console.log('External scripts loaded, executing inline scripts');
                            // Now execute inline scripts
                            inlineScripts.forEach(oldScript => {
                                const newScript = document.createElement('script');
                                newScript.textContent = oldScript.textContent;
                                outputElement.appendChild(newScript);
                            });
                            console.log('Output element after processing:', outputElement.children.length, 'children');
                        })
                        .catch(err => {
                            console.error('Failed to load external scripts:', err);
                            outputElement.textContent = 'Error loading Plotly: ' + err.message;
                        });
                } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                           trimmedOutput.startsWith('<html') ||
                           trimmedOutput.startsWith('<div')) {
                    console.log('Rendering as generic HTML');
                    outputElement.innerHTML = result.output;
                    console.log('Output element after innerHTML:', outputElement.children.length, 'children');
                } else {
                    console.log('Rendering as plain text');
                    outputElement.textContent = result.output;
                }
                outputElement.classList.remove("loading-message");
                if (result.success) {
                    outputElement.classList.add("success-message");
                    outputElement.classList.remove("error-message");
                } else {
                    outputElement.classList.add("error-message");
                    outputElement.classList.remove("success-message");
                }
            }
            
            // Small delay to show progression
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Setup all editable code blocks (but don't execute them)
        document.querySelectorAll('.code-editor textarea').forEach((textarea) => {
            // Set up CodeMirror editor (editable)
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: "python",
                theme: "pastel-on-dark",
                lineNumbers: true,
                viewportMargin: Infinity
            });
            
            // Find corresponding run button and output element
            const baseId = textarea.id;
            const runButtonId = 'run-' + baseId;
            const outputId = baseId + '-output';
            
            const runButton = document.getElementById(runButtonId);
            const outputElement = document.getElementById(outputId);
            
            if (runButton && outputElement) {
                // Set initial state
                outputElement.textContent = "Ready to run code!";
                outputElement.classList.remove("loading-message");
                
                runButton.addEventListener("click", async () => {
                    const code = editor.getValue().trim();
                    if (!code) {
                        outputElement.textContent = "No code to run";
                        return;
                    }
                    
                    outputElement.textContent = "Running...";
                    outputElement.classList.remove("error-message", "success-message");
                    outputElement.classList.add("loading-message");
                    
                    // Execute the code (this also maintains state for future blocks)
                    const result = await executePythonCode(code);
                    
                    // Display the output - check if it's HTML
                    const trimmedOutput = result.output.trim();
                    console.log('Output length:', trimmedOutput.length);
                    console.log('Output starts with:', trimmedOutput.substring(0, 100));
                    
                    if (trimmedOutput.includes('<script') && trimmedOutput.includes('Plotly')) {
                        // It's Plotly HTML output - extract just the body content
                        console.log('Rendering as Plotly HTML');
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(result.output, 'text/html');
                        // Clear the output element and append the body content
                        outputElement.innerHTML = '';
                        
                        // Find and load external scripts first (like Plotly CDN)
                        const externalScripts = Array.from(doc.querySelectorAll('script[src]'));
                        const inlineScripts = Array.from(doc.querySelectorAll('script:not([src])'));
                        
                        // Append non-script content first
                        Array.from(doc.body.children).forEach(child => {
                            if (child.tagName !== 'SCRIPT') {
                                outputElement.appendChild(child.cloneNode(true));
                            }
                        });
                        
                        // Load external scripts sequentially
                        const loadScript = (src) => {
                            return new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = src;
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        };
                        
                        // Load all external scripts first
                        Promise.all(externalScripts.map(s => loadScript(s.src)))
                            .then(() => {
                                console.log('External scripts loaded, executing inline scripts');
                                // Now execute inline scripts
                                inlineScripts.forEach(oldScript => {
                                    const newScript = document.createElement('script');
                                    newScript.textContent = oldScript.textContent;
                                    outputElement.appendChild(newScript);
                                });
                                console.log('Output element after processing:', outputElement.children.length, 'children');
                            })
                            .catch(err => {
                                console.error('Failed to load external scripts:', err);
                                outputElement.textContent = 'Error loading Plotly: ' + err.message;
                            });
                    } else if (trimmedOutput.startsWith('<!DOCTYPE') || 
                               trimmedOutput.startsWith('<html') ||
                               trimmedOutput.startsWith('<div')) {
                        outputElement.innerHTML = result.output;
                    } else {
                        outputElement.textContent = result.output;
                    }
                    outputElement.classList.remove("loading-message");
                    if (result.success) {
                        outputElement.classList.add("success-message");
                        outputElement.classList.remove("error-message");
                    } else {
                        outputElement.classList.add("error-message");
                        outputElement.classList.remove("success-message");
                    }
                });
            }
        });
        
        console.log("All code blocks initialised successfully");
        
    } catch (error) {
        console.error("Failed to initialise Pyodide:", error);
        document.querySelectorAll(".output").forEach(el => {
            el.textContent = "Error loading Pyodide: " + error.message;
            el.classList.remove("loading-message");
            el.classList.add("error-message");
        });
    }
}

// Start the application when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', main);
} else {
    main();
}
    </script>
</body>
</html>
    